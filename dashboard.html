<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard | AI Health Monitor</title>

<link rel="stylesheet" href="styles.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<style>
  /* Badge styling (missing previously) */
  .badge {
    margin-top: 8px;
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    color: white;
  }
</style>

<script>
  // Apply dark mode immediately
  (function() {
    const theme = localStorage.getItem('theme') || 'light';
    if (theme === 'dark') document.documentElement.classList.add('dark-mode');
  })();
</script>
</head>
<body>

<!-- Back Button -->
<button class="back-btn" onclick="window.location.href='signin.html'">â† Back</button>

<div class="dashboard-container">

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2 class="logo">AI<span>Health</span></h2>
    <nav class="nav-links">
      <a href="./dashboard.html" class="active">ğŸ“Š Dashboard</a>
      <a href="./healthlogs.html">ğŸ“‹ Health Logs</a>
      <a href="./settings.html">âš™ï¸ Settings</a>
      <a href="./device.html">ğŸ”Œ Device</a>
      <a href="./ai-assistant.html">
  <img src="chatbot.jpg" alt="Chatbot Icon" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;">
  AlertoBot
</a>
      <a href="./about.html">â„¹ï¸ About</a>
      <a href="#" id="logout-btn">ğŸšª Logout</a>
    </nav>
  </aside>

  <!-- Main Dashboard -->
  <main class="main-content">
    <header class="dashboard-header">
      <h1 id="welcome-text">Welcome, User ğŸ‘‹</h1>
      <p>Here's your latest health summary</p>
    </header>

    <!-- Alert Banner -->
<!-- Professional Alert Banner -->
<div id="alert-banner" class="alert-banner">
  <div class="alert-icon">âœ”</div>
  <div class="alert-text">
    <h3 id="alert-title">Normal Status</h3>
    <p id="alert-message">Your vitals are within healthy range.</p>
  </div>
</div>


    <!-- Health Cards -->
    <section class="cards">
      <div class="card">
        <h3>â¤ï¸ Heart Rate</h3>
        <p class="value">â€” <span>BPM</span></p>
        <span id="hr-badge" class="badge">Normal</span>
      </div>

      <div class="card">
        <h3>ğŸŒ¬ï¸ SpOâ‚‚</h3>
        <p class="value">â€” <span>%</span></p>
        <span id="spo2-badge" class="badge">Normal</span>
      </div>
    </section>

    <!-- Chart Section -->
    <section class="chart-section">
      <h2>Health Progression Graph</h2>
      <div class="chart-container">
        <canvas id="healthChart"></canvas>
      </div>
    </section>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===================== GLOBAL CONFIG ===================== */
const API_URL = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";
const token = localStorage.getItem("access_token");

if (!token) window.location.href = "signin.html";

// Logout
document.getElementById("logout-btn").addEventListener("click", (e) => {
  e.preventDefault();
  localStorage.clear();
  window.location.href = "signin.html";
});

/* ===================== SAFE FETCH JSON ===================== */
async function fetchJSON(url, options = {}) {
  options.headers = {
    ...(options.headers || {}),
    "Authorization": `Bearer ${token}`,
    "ngrok-skip-browser-warning": "true"
  };
  try {
    const res = await fetch(url, options);
    const text = await res.text();
    try {
      return { ok: res.ok, data: JSON.parse(text) };
    } catch {
      console.error("âŒ NGROK returned HTML instead of JSON:", text);
      return { ok: false, error: "Invalid JSON from server", raw: text };
    }
  } catch (err) {
    console.error("âŒ Fetch failed:", err);
    return { ok: false, error: "Fetch failed", raw: err };
  }
}

/* ===================== LOAD USER INFO ===================== */
async function loadUserName() {
  const { ok, data, error } = await fetchJSON(`${API_URL}/user-info`);
  if (!ok) return console.error("Failed to load user:", error);
  if (data.fullname) {
    document.getElementById("welcome-text").innerText =
      `Welcome, ${data.fullname.split(" ")[0]} ğŸ‘‹`;
  }
}

function showAlert(alertData) {
  const banner = document.getElementById("alert-banner");
  const title = document.getElementById("alert-title");
  const message = document.getElementById("alert-message");

  banner.classList.remove("alert-normal", "alert-warning", "alert-critical");

  const levelClass = {
    0: "alert-normal",
    1: "alert-warning",
    2: "alert-critical"
  };

  banner.classList.add(levelClass[alertData.level] || "alert-normal");
  banner.classList.add("show");

 // Icons for left-side icon box
const icons = { 0: "âœ”", 1: "âš ", 2: "â›”" };

// Update left icon
document.querySelector(".alert-icon").textContent = icons[alertData.level];

// Text without emoji
title.textContent = `${alertData.level_name} Status`;
message.textContent = alertData.message;


  updateBadges(alertData);
}

function updateBadges(alertData) {
  const hrBadge = document.getElementById("hr-badge");
  const spo2Badge = document.getElementById("spo2-badge");

  const colors = {
    0: "#27ae60",
    1: "#f39c12",
    2: "#e74c3c"
  };

  const color = colors[alertData.level] || "#95a5a6";
  const text = alertData.level_name || "Unknown";

  [hrBadge, spo2Badge].forEach(badge => {
    badge.textContent = text;
    badge.style.backgroundColor = color;
    badge.style.color = "white";
  });
}

/* ===================== LOAD LATEST VITALS ===================== */
async function loadVitals() {
  const { ok, data, error } = await fetchJSON(`${API_URL}/healthlogs`);
  if (!ok) return console.error("Failed to load vitals:", error);
  if (!Array.isArray(data) || data.length === 0) return;

  const latest = data[0];
  document.querySelector(".card:nth-child(1) .value").innerHTML =
    `${latest.heart_rate ?? "â€”"} <span>BPM</span>`;
  document.querySelector(".card:nth-child(2) .value").innerHTML =
    `${latest.spo2 ?? "â€”"}<span>%</span>`;

  if (latest.alert_info) {
    showAlert({
      level: latest.alert_level,
      level_name: latest.alert_info.level_name,
      message: latest.alert_message,
      color: latest.alert_info.color
    });
  }

  updateChart(data);
}

/* ===================== INITIALIZE CHART ===================== */
const ctx = document.getElementById("healthChart").getContext("2d");
const isDarkMode = localStorage.getItem("theme") === "dark";

const healthChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label: "Heart Rate (BPM)", data: [], borderColor: "#ff4d6d", backgroundColor: "rgba(255,77,109,0.2)", tension: 0.4, fill: false },
      { label: "SpOâ‚‚ (%)", data: [], borderColor: "#00c853", backgroundColor: "rgba(0,200,83,0.2)", tension: 0.4, fill: false }
    ]
  },
  options: {
    responsive: true,
    interaction: { mode: "index", intersect: false },
    plugins: {
      legend: { labels: { color: isDarkMode ? "#fff" : "#000", font: { size: 13 } } },
      tooltip: {
        callbacks: {
          label: ctx => ctx.dataset.label.includes("Heart") ?
            `${ctx.dataset.label}: ${ctx.parsed.y} BPM` :
            `${ctx.dataset.label}: ${ctx.parsed.y}%`
        }
      }
    },
    scales: {
      x: { ticks: { color: isDarkMode ? "#fff" : "#000" }, grid: { color: isDarkMode ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)" } },
      y: { ticks: { color: isDarkMode ? "#fff" : "#000" }, grid: { color: isDarkMode ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)" } }
    }
  }
});

function updateChart(records) {
  const last7 = records.slice(0, 7).reverse();
  healthChart.data.labels = last7.map(r =>
    new Date(r.timestamp).toLocaleDateString("en-US", { month: "short", day: "numeric" })
  );
  healthChart.data.datasets[0].data = last7.map(r => r.heart_rate ?? 0);
  healthChart.data.datasets[1].data = last7.map(r => r.spo2 ?? 0);
  healthChart.update();
}

/* ===================== INITIAL LOAD ===================== */
document.addEventListener("DOMContentLoaded", () => {
  loadUserName();
  loadVitals();
  setInterval(loadVitals, 5000);
});
</script>

<script src="device.js"></script>
</body>
</html>
