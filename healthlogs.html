<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Logs | AI Health Monitor</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    .table-wrapper {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: white;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <button class="back-btn" onclick="window.location.href='dashboard.html'">â† Back</button>

  <div class="dashboard-container">
    <aside class="sidebar">
      <h2 class="logo">AI<span>Health</span></h2>
      <nav class="nav-links">
        <a href="./dashboard.html"><img src="dashboard.png" class="nav-icon"> Dashboard</a>
        <a href="./healthlogs.html" class="active">ğŸ“‹ Health Logs</a>
        <a href="./settings.html">âš™ï¸ Settings</a>
        <a href="./device.html">ğŸ”Œ Device</a>
        <a href="./ai-assistant.html">
          <img src="chatbot.jpg" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;">
          AlertoBot
        </a>
        <a href="./about.html">â„¹ï¸ About</a>
        <a href="./signin.html">ğŸšª Logout</a>
      </nav>
    </aside>

    <main class="main-content">

      <header class="dashboard-header">
        <h1>Health Logs</h1>
        <p>Your recent monitoring records from ESP32 sensor</p>
      </header>

      <section class="live-vitals">
        <h2>ğŸ“¡ Latest Reading</h2>
        <div class="vitals-grid">
          <div class="vital-box"><h3>â¤ï¸ Heart Rate</h3><p id="live-heart-rate">â€”</p></div>
          <div class="vital-box"><h3>ğŸŒ¬ï¸ SpOâ‚‚</h3><p id="live-spo2">â€”</p></div>
          <div class="vital-box"><h3>ğŸ•’ Timestamp</h3><p id="live-timestamp">â€”</p></div>
        </div>
      </section>

      <section class="logs-section">
        <h2>ğŸ“‹ Recent Health Records</h2>
        <button id="refresh-btn">ğŸ”„ Refresh</button>

        <div class="table-wrapper">
          <table class="logs-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>â¤ï¸ Heart Rate</th>
                <th>ğŸŒ¬ï¸ SpOâ‚‚</th>
                <th>IR</th>
                <th>RED</th>
              </tr>
            </thead>
            <tbody id="health-log-body">
              <tr><td colspan="6" style="text-align:center; padding:15px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

<script>
/* ============================================================
   ğŸ”¥ CONFIG â€” YOUR NGROK URL
============================================================ */
const FLASK_URL = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";

/* DOM Elements */
const token = localStorage.getItem("access_token");
const tableBody = document.getElementById("health-log-body");
const refreshBtn = document.getElementById("refresh-btn");

/* Helpers */
function formatDateTime(ts) {
  if (!ts || isNaN(Date.parse(ts))) return { date: "â€”", time: "â€”" };
  const d = new Date(ts);
  return {
    date: d.toLocaleDateString("en-CA"),
    time: d.toLocaleTimeString("en-US", { hour12: false })
  };
}

function renderRow(r) {
  const t = formatDateTime(r.timestamp);
  return `
    <tr>
      <td>${t.date}</td>
      <td>${t.time}</td>
      <td>${r.heart_rate ?? "â€”"}</td>
      <td>${r.spo2 ?? "â€”"}</td>
      <td>${r.ir ?? "â€”"}</td>
      <td>${r.red ?? "â€”"}</td>
    </tr>`;
}

function updateLatestVitals(records) {
  if (!records.length) return;
  const r = records[0];
  document.getElementById("live-heart-rate").textContent = r.heart_rate ?? "â€”";
  document.getElementById("live-spo2").textContent = r.spo2 ?? "â€”";
  document.getElementById("live-timestamp").textContent = formatDateTime(r.timestamp).time;
}

/* ============================================================
   ğŸ”¥ FIXED FETCH WRAPPER â€” prevents HTML ngrok errors
============================================================ */
async function fetchJSON(url, options = {}) {

  // Add ngrok bypass header
  options.headers = {
    ...(options.headers || {}),
    "ngrok-skip-browser-warning": "true"
  };

  const res = await fetch(url, options);
  const raw = await res.text();

  try {
    return { ok: res.ok, data: JSON.parse(raw) };
  } catch {
    console.error("âŒ NGROK RETURNED HTML instead of JSON:\n", raw);
    return { ok: false, error: "Invalid JSON from server", raw };
  }
}

/* ============================================================
   ğŸ”¥ MAIN FUNCTION â€” Load logs
============================================================ */
async function loadHealthLogs() {

  if (!token) {
    tableBody.innerHTML =
      `<tr><td colspan="6" style="text-align:center; color:red;">âš ï¸ You must log in first.</td></tr>`;
    return;
  }

  const { ok, data, error, raw } = await fetchJSON(`${FLASK_URL}/healthlogs`, {
    method: "GET",
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!ok) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; color:red;">
          âŒ Error loading logs<br>
          <small>${error}</small>
        </td>
      </tr>`;
    return;
  }

  if (!Array.isArray(data) || data.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">ğŸ“­ No records found.</td></tr>`;
    return;
  }

  tableBody.innerHTML = data.map(renderRow).join("");
  updateLatestVitals(data);
}

/* Events */
refreshBtn.addEventListener("click", loadHealthLogs);

/* Auto-refresh every 5s */
loadHealthLogs();
setInterval(loadHealthLogs, 5000);
</script>

</body>
</html>
